# Copyright Bosch Software Innovations GmbH, 2016.
# Part of the SW360 Portal Project.
#
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Eclipse Public License v1.0
# which accompanies this distribution, and is available at
# http://www.eclipse.org/legal/epl-v10.html

FROM debian:jessie
MAINTAINER admin@sw360.org
ENV DEBIAN_FRONTEND noninteractive

ENV _update="apt-get update"
ENV _install="apt-get install -y --no-install-recommends"
ENV _cleanup="eval apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*"

RUN set -x \
 && $_update && $_install git-core python3 python3-dev python3-pip gcc \
        python-anyjson python-argparse python-pymongo \
        libxml2 python-libxml2 libxml2-dev libxslt-dev libxslt1-dev python-dev zlib1g-dev \
        cron \
 && $_cleanup

run mkdir -p /cve-search
WORKDIR /cve-search
run if [ "$http_proxy" = "None" ]; then unset http_proxy; fi && if [ "$https_proxy" = "None" ]; then unset https_proxy; fi \
 && set -x \
 && git clone https://github.com/cve-search/cve-search /cve-search \
 && (git checkout 7a000ec5e27cc765d80470d5d28a4cc59000d108 2>&1) \
 && pip3 install -q -U pip \
 && pip install -r requirements.txt \
 && cp etc/configuration.ini.sample etc/configuration.ini \
 && sed -i 's/Host: 127.0.0.1/Host: 0.0.0.0/' etc/configuration.ini

COPY docker-entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

EXPOSE 5000

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["server"]
