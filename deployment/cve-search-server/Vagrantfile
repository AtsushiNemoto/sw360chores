# -*- mode: ruby -*-
# vi: set ft=ruby :

# Copyright Bosch Software Innovations GmbH, 2016.
# Part of the SW360 Portal Project.
#
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Eclipse Public License v1.0
# which accompanies this distribution, and is available at
# http://www.eclipse.org/legal/epl-v10.html

Vagrant.configure(2) do |config|
  config.vm.box = "ubuntu/trusty64"
  config.vm.provider "virtualbox" do |vb|
    vb.memory = 6000
    vb.cpus = 3
  end

  config.vm.provision "shell", inline: <<-SHELL
set -xe

apt-get install -y -q apt-transport-https ca-certificates
apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D
echo "deb https://apt.dockerproject.org/repo ubuntu-trusty main" > /etc/apt/sources.list.d/docker.list
apt-get update
apt-get install -y -q docker-engine
usermod -a -G docker vagrant

[ -e /usr/bin/docker-compose ] || curl -L https://github.com/docker/compose/releases/download/1.7.0/docker-compose-`uname -s`-`uname -m` > /usr/bin/docker-compose 2> /dev/null
chmod +x /usr/bin/docker-compose
SHELL

  if File.exists?(File.join(File.dirname(__FILE__),".vagrant/machines/default/virtualbox/action_provision"))
    # build and run with docker compose
    config.vm.provision "shell", run: "always", privileged: false, inline: <<-SHELL
set -xe
cd /vagrant

docker-compose build
docker-compose up
SHELL
  end

  config.vm.network "forwarded_port", guest: 5000, host: 5000
end
